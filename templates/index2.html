<html>
<head>
    <title>Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link rel='stylesheet' href="static/css/bootstrap.min 2.css">
    <link rel='stylesheet' href="static/css/bootstrap-material-design.css">
    <link rel='stylesheet' href="static/css/icon.css">
    <link rel="stylesheet" href="static/css/style 2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
<body>
</body>
<div>
  <div id="chat-circle" style="display:none;" class="btn btn-raised">
    <img src="static/images/logo-img.png" class="img-fluid">
  </div>
  <div class="chat-box" style="display:block;">
    <div class="chat-box-header">
      <div class="chat_box_header_logo d-flex align-items-center">
        <a href="">
          <img src="static/images/logo-img.png" class="img-fluid">
        </a>
        <div class="header_name">
          <h1><strong>How can I assist you today?</strong></h1>
    
        </div>
      </div>
      <div class="header_btn d-flex" style="gap:4px;">
        <span class="chat-box-mute">
          <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 13 15" fill="none">
            <path
              d="M1.37366 10.3959C1.60845 10.5377 1.68445 10.8428 1.54267 11.0776C1.40088 11.3124 1.09577 11.3884 0.860977 11.2466C0.628454 11.1059 0.433362 10.9063 0.298385 10.6681C0.166811 10.4367 0.0919495 10.1702 0.0919495 9.89002V5.1783C0.0919495 4.74161 0.270028 4.34576 0.556996 4.05879C0.843963 3.77182 1.23982 3.59374 1.67651 3.59374H5.35151L8.48093 0.445039C8.67376 0.251081 8.98795 0.249947 9.1819 0.442771C9.27945 0.539183 9.32822 0.667354 9.32822 0.794391H9.32936V3.37483C9.32936 3.64932 9.10704 3.87277 8.83142 3.87277C8.55693 3.87277 8.33348 3.65046 8.33348 3.37483V1.99897L5.93339 4.41495C5.84265 4.52157 5.70653 4.58962 5.55568 4.58962H1.67651C1.51431 4.58962 1.36686 4.65654 1.26024 4.76317C1.15362 4.86979 1.0867 5.01724 1.0867 5.17944V9.89115C1.0867 9.99777 1.11392 10.0953 1.16156 10.1793C1.21146 10.2677 1.28519 10.3426 1.37366 10.3959ZM1.70373 13.7703C1.50977 13.9643 1.19445 13.9643 1.00049 13.7703C0.806533 13.5764 0.806533 13.261 1.00049 13.0671L11.2757 2.79182C11.4697 2.59786 11.785 2.59786 11.979 2.79182C12.1729 2.98578 12.1729 3.3011 11.979 3.49506L1.70373 13.7703ZM8.33461 8.50055C8.33461 8.22606 8.55693 8.00261 8.83255 8.00261C9.10704 8.00261 9.33049 8.22492 9.33049 8.50055V13.7386C9.33049 14.0131 9.10818 14.2365 8.83255 14.2365C8.69871 14.2365 8.57848 14.1843 8.48887 14.0993L5.89595 11.9873C5.68385 11.8149 5.65096 11.5018 5.8245 11.2897C5.9969 11.0776 6.30996 11.0447 6.52207 11.2182L8.33575 12.695V8.50055H8.33461Z"
              fill="black" />
          </svg>
        </span>
        <span class="chat-box-toggle">
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10" fill="none">
            <path d="M8.4713 1.07407L0.890182 8.65518" stroke="black" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
            <path d="M0.890182 1.07407L8.47129 8.65518" stroke="black" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </span>
      </div>
    </div>
    <div class="chat-box-body">
      <div class="chat-box-overlay"></div>
      <div class="days text-center"><span>Today </span></div>
      <div class="chat-logs">
{% csrf_token %}
<div class="chat_section">
    <div id="display">
    
  
    <div id="type-box">
      <div id="product-slider" style="display: none;">
        <!-- Add your product content here -->
      </div>
      
      <fieldset>
    
        <datalist id="browsers" role="listbox">
          {% for question in questions %}
          <option value="{{ question }}">{{ question }}</option>
          {% endfor %}
        </datalist>
      </fieldset>
     
    </div>
  </div>
   <!--chat-log -->
  </div>
  <div class="chat-input">
    <form>
      <input type="text" id="chat-input" placeholder="Write your message" />
      <button type="submit" onclick="send()" class="chat-submit" id="chat-submit">
        <img src="static/images/microphone.png" class="microphone">

        <div class="send_btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-send-fill"
            viewBox="0 0 16 16">
            <path
              d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z" />
          </svg>
        </div>
      </button>
    </form>
  </div>
</div>
</div>
<!-- partial -->
<script src="static/js/jquery.min.js"></script>


<script src="static/js/script.js"></script>
</body>

</html>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
<script>

  
  
  function createSlide(item) {
    return `<div class="slider-item">
              <img src="${item.image_url}" alt="${item.name}">
              <p>${item.name}</p>
            </div>`;
  }
function send() {
  var csrfToken = "{{ csrf_token }}";
    var input = document.getElementById("chat-input").value;
    var display = document.getElementById("display");
    var ansBtn7 = document.getElementById("ans-btn7");
    var send = document.getElementById("send");
    var url = "/generate-stream"
    console.log(input);

      function getoldmessages(){
        const oldmessages = []
        const Allmessagedivs = display.querySelectorAll("div")
        for (let i = 0; i < Allmessagedivs.length; i++) {
          const messagediv = Allmessagedivs[i];
          if(messagediv.classList.contains("self"))
          {
            oldmessages.push({role:"user",content:messagediv.querySelector('.cm-msg-text > h3').innerHTML})
          }else if(messagediv.classList.contains("user")){
            oldmessages.push({role:"system",content:messagediv.querySelector('.cm-msg-text').innerHTML})
          }
        }
        return oldmessages
      }

    // Function to handle streaming data from Django backend
        async function streamDataFromBackend() {
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                "X-CSRFToken": csrfToken,  // Include the CSRF token in the header
                "Content-Type": "application/json",  // Set the content type accordingly
            },
              body:JSON.stringify({messages:[...getoldmessages(),{role:"user",content:input}]})
            });

            // Check if the response status is OK (HTTP status code 200)
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }

            // Create a ReadableStream from the response
            const stream = response.body;

            // Define a function to process the streamed data
            const processData = async (reader,messageelm) => {
              while (true) {
                const { done, value } = await reader.read();

                if (done) {
                  break; // Exit the loop when the stream ends
                }

                // Process the received data (value) here
      
                const textDecoder = new TextDecoder();

                // Decode the byte data to text
                const decodedText = textDecoder.decode(value);
                console.log(decodedText)
                if(isJSON(decodedText)){
                  const wordData = JSON.parse(decodedText)
                  if(wordData.type==='products'){
                    myfinaldata= wordData["data"]["products"]
                    myfinaldata.data.forEach((item) => {
                      const slide = createSlide(item);
                      slider.append(slide);
                    });
                  
                    slider.slick({
                      slidesToShow: 1,
                      slidesToScroll: 1,
                      autoplay: true,
                      autoplaySpeed: 2000, 
                    });
                  }
                }else{
                  messageelm.append(decodedText);
                }
                

              }
            };
            // Start processing the streamed data
            const reader = stream.getReader();


            const elm = document.createElement("div");
            elm.id = "cm-msg-2";
            elm.className = "chat-msg user";

            const answerDiv = document.createElement("div");
            answerDiv.className = "answer";

            const cmMsgTextDiv = document.createElement("div");
            cmMsgTextDiv.className = "cm-msg-text";

            answerDiv.appendChild(cmMsgTextDiv);
            elm.appendChild(answerDiv);

            result=display.appendChild(elm);
            console.log("---",result)
            await processData(reader,cmMsgTextDiv);
           
            // Check the content inside cmMsgTextDiv for the "Found products:" message
            const cmMsgTextContent = cmMsgTextDiv.textContent;
            if (cmMsgTextContent.includes("Found products:")) {
              const productSlider = document.getElementById("product-slider");
              productSlider.style.display = "block";

              for (const product of found_products) {
                const productElement = document.createElement("div");
                productElement.textContent = `Name: ${product.name}, Group: ${product.group}, Image: ${product.image}`;
                productSlider.appendChild(productElement);
              }``
            }


          } catch (error) {
            console.error('An error occurred:', error);
          }
        }

        // Call the function to start streaming data
        streamDataFromBackend();




    //set the user input to the chatbox
    display.innerHTML=display.innerHTML+"<div class='chat-msg self'> <div class='cm-msg-text'><h3>"+input+"</h3></div></div>";

    document.getElementById("chat-input").value="";

   
    }
    function isJSON(str) {
      try {
        JSON.parse(str);
        return true;
      } catch (e) {
        return false;
      }
    }
   
</script>
</html>